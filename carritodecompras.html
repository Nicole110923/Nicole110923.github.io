<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Carrito de Compras | N'C BOOKS</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 700px; margin: auto; padding: 20px; background: #fafafa; color: #333; }
  h1 { color: #4b007d; }
  #carrito-contenido .item { display: flex; align-items: center; gap: 15px; margin-bottom: 10px; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 0 8px #ddd; }
  #carrito-contenido img { width: 60px; height: 80px; object-fit: cover; border-radius: 5px; }
  .item-info { flex-grow: 1; }
  button.btn-eliminar { background: #7a00cc; border: none; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
  #total { font-weight: bold; margin-top: 20px; font-size: 1.2rem; }
  #formulario-compra { margin-top: 30px; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 0 10px #ccc; display: none; }
  label { display: block; margin-top: 10px; }
  input, select { width: 100%; padding: 7px; margin-top: 5px; border: 1px solid #ccc; border-radius: 6px; }
  button#pagar { margin-top: 15px; background: #4b007d; color: white; border: none; padding: 10px; border-radius: 8px; font-size: 1rem; cursor: pointer; }
  button#vaciar { margin-left: 10px; background: #cc0044; }
  button#mostrar-form { background: #007a99; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; }
</style>
</head>
<body>

<h1>Tu Carrito de Compras</h1>
<div id="carrito-contenido"></div>
<p id="total">Total: $0.00</p>

<button id="mostrar-form">Pagar</button>
<button id="vaciar">Vaciar Carrito</button>

<form id="formulario-compra" novalidate>
  <h2>Datos de Pago</h2>
  <form id="form-compra">
    <label for="nombre">Nombre Completo</label>
    <input id="nombre" name="nombre" type="text" required />

    <label for="direccion">Dirección</label>
    <input id="direccion" name="direccion" type="text" required />

    <label for="tipo-tarjeta">Tipo de Tarjeta</label>
    <select id="tipo-tarjeta" name="tipo-tarjeta" required>
      <option value="" disabled selected>Selecciona una</option>
      <option value="Visa">Visa</option>
      <option value="Mastercard">Mastercard</option>
      <option value="Amex">American Express</option>
    </select>

    <label for="numero">Número de Tarjeta</label>
    <input id="numero" name="numero" type="text" maxlength="16" pattern="\d{13,16}" required />

    <label for="cvv">CVV</label>
    <input id="cvv" name="cvv" type="text" maxlength="4" pattern="\d{3,4}" required />

    <button id="pagar" type="submit">Confirmar Pago</button>
  </form>
</form>

<script>
document.addEventListener('DOMContentLoaded', () => {
  let carrito = JSON.parse(localStorage.getItem('carrito')) || [];

  const contenedor = document.getElementById('carrito-contenido');
  const totalTexto = document.getElementById('total');
  const formulario = document.getElementById('formulario-compra');
  const formCompra = document.getElementById('form-compra');
  const btnMostrarForm = document.getElementById('mostrar-form');
  const btnVaciar = document.getElementById('vaciar');

  function renderCarrito() {
    contenedor.innerHTML = '';
    if (carrito.length === 0) {
      contenedor.innerHTML = '<p>Tu carrito está vacío.</p>';
      formulario.style.display = 'none';
      totalTexto.textContent = 'Total: $0.00';
      btnMostrarForm.disabled = true;
      btnVaciar.disabled = true;
      return;
    }
    btnMostrarForm.disabled = false;
    btnVaciar.disabled = false;

    let total = 0;
    carrito.forEach((item, index) => {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <img src="${item.imagen}" alt="${item.nombre}">
        <div class="item-info">
          <strong>${item.nombre}</strong><br>
          $${item.precio.toFixed(2)} x ${item.cantidad}
        </div>
        <button type="button" data-index="${index}" class="btn-eliminar">Eliminar</button>
      `;
      contenedor.appendChild(div);
      total += item.precio * item.cantidad;
    });
    totalTexto.textContent = `Total: $${total.toFixed(2)}`;
  }

  contenedor.addEventListener('click', e => {
    if (e.target.classList.contains('btn-eliminar')) {
      const index = Number(e.target.getAttribute('data-index'));
      carrito.splice(index, 1);
      localStorage.setItem('carrito', JSON.stringify(carrito));
      renderCarrito();
    }
  });

  btnVaciar.addEventListener('click', () => {
    if (confirm('¿Vaciar el carrito?')) {
      carrito = [];
      localStorage.setItem('carrito', JSON.stringify(carrito));
      renderCarrito();
    }
  });

  btnMostrarForm.addEventListener('click', () => {
    if (carrito.length === 0) {
      alert('Tu carrito está vacío.');
      return;
    }
    formulario.style.display = 'block';
    formulario.scrollIntoView({ behavior: 'smooth' });
  });

  // Validar inputs numéricos para tarjeta y CVV
  document.getElementById('numero').addEventListener('input', e => {
    e.target.value = e.target.value.replace(/\D/g, '').slice(0, 16);
  });
  document.getElementById('cvv').addEventListener('input', e => {
    e.target.value = e.target.value.replace(/\D/g, '').slice(0, 4);
  });

  formCompra.addEventListener('submit', e => {
    e.preventDefault();

    if (!formCompra.checkValidity()) {
      alert('Por favor, completa todos los campos correctamente.');
      return;
    }

    const nombre = formCompra.nombre.value.trim();
    const direccion = formCompra.direccion.value.trim();
    const tipoTarjeta = formCompra['tipo-tarjeta'].value;
    const total = carrito.reduce((acc, item) => acc + item.precio * item.cantidad, 0);

    // Guardamos comprobante en sessionStorage
    const comprobante = {
      nombre,
      direccion,
      tipoTarjeta,
      total: total.toFixed(2),
      productos: carrito
    };

    sessionStorage.setItem('comprobante', JSON.stringify(comprobante));

    // Vaciar carrito
    carrito = [];
    localStorage.setItem('carrito', JSON.stringify(carrito));

    alert('Compra realizada con éxito!');
    window.location.href = 'comprobante.html';
  });

  renderCarrito();
});
</script>

</body>
</html>
